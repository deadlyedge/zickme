{% extends "base.html" %}

{% block page_content %}
<div id="showPicture">
    <video id="videoXP" autoplay playsinline></video>
    <canvas id="canvas"></canvas>
<!--    <img id="imageSnapped" src="">-->
    <div id="showWords"></div>
</div>
<form action="" method="post"
      class="form" enctype="multipart/form-data">
        <p class="directions">Gives you by "Someone" or from "Somewhere". 不知从哪里弄来的口令</p>
    <div class="input-group mb-3 required" id="passDiv">
        <span class="input-group-text" id="basic-addon1">!PASS</span>
        <input class="form-control input-lg" id="passArea" name="passArea"
               required placeholder="输入你的口令">
    </div>
<!--    <div id="getPicture">-->
<!--    </div>-->
    <input class="btn btn-outline-warning" id="reset" name="reset" type="button" value="One more...">
    <input class="btn btn-outline-success" id="submit" name="submit" type="submit" value="Start vTag!">
</form>
{% endblock %}
{% block scripts %}
{{ super() }}
<script>
$(document).ready(function () {
    $('#vTag').addClass('active');
    const webcamElement = document.getElementById('videoXP');
    const canvasElement = document.getElementById('canvas');
    const webcam = new Webcam(webcamElement, 'environment', canvasElement);  //
    var picture = null;
    var refreshMeter = null
    $('#passArea').focus()

    webcam.start()
    .then(result =>{
        console.log("webcam started");
    })
    .catch(err => {
        console.log(err);
    });

    function getCanvas(){
        console.log("refresh");
        let snapped = webcam.snap();
        picture = canvasElement.toDataURL('image/jpeg');
        var data = {
            passArea: $('#passArea').val(),
            picture: picture
        };
        $.ajax({
            type: 'POST',
            url: '/vTag',
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (response) {
                $('#passDiv, #submit').hide();
                if(response){
                    $('#showWords').text(response);
                    $('#showWords').show();
                    //webcam.stop();
                    //window.clearInterval(refreshMeter);
                } else {
                    $('#showWords').hide();
                };
                $("#submit").prop("disabled", false);
            }
        });
    }

    //var refreshMeter = window.setInterval(getCanvas, 500);

    $('#reset').click(function() {
        picture = null;
        $('#imageSnapped').attr('src', '');
        $('#passArea').val('');
        $('#showWords').text('');
        $('#showWords').hide();
        $('#videoEX, #passDiv, #submit, #snap, .directions').show(500);
        $('#passArea').focus();
        window.clearInterval(refreshMeter);
        //webcam.start()
    });

    $('#submit').click(function(event) {
        event.preventDefault();
        if( !$('#passArea').val() ) {
            alert('需要填写PASS');
            $('#passArea').focus();
            return false;
        };
        refreshMeter = window.setInterval(getCanvas, 2000);
    });
});
</script>
{% endblock %}
